#! /usr/bin/make -f

include Makefile

TIME = $(shell date +%T.%3N)
YELLOW := "\033[1;33m"
GREEN := "\033[1;32m"
NC := "\033[0m" # No Color


#  This target requires sassc package!!!
css: $(ADMIN_DIR)/mfw-all.css $(SETTINGS_DIR)/mfw-all.css
$(ADMIN_DIR)/mfw-all.css $(SETTINGS_DIR)/mfw-all.css: $(SASS)
	@echo $(TIME) $(GREEN)"Building CSS"$(NC)
	@cat $^ | sassc --style expanded --stdin $@

js-admin: $(ADMIN_DIR)/mfw-admin-all.js
$(ADMIN_DIR)/mfw-admin-all.js: $(APP_ADMIN_ALL)
	@echo $(TIME) $(GREEN)"Building the Admin App"$(NC)
	@cat $^ > $@

html-admin: $(ADMIN_DIR)/index.html
$(ADMIN_DIR)/index.html: app/admin/index.html
	@echo $(TIME) $(GREEN)"Copy Admin index file"$(NC)
	@cp $^ $@

js-settings: $(SETTINGS_DIR)/mfw-settings-all.js
$(SETTINGS_DIR)/mfw-settings-all.js: $(APP_SETTINGS_ALL)
	@echo $(TIME) $(GREEN)"Building the Settings App"$(NC)
	@cat $^ > $@

html-settings: $(SETTINGS_DIR)/index.html
$(SETTINGS_DIR)/index.html: app/settings/index.html
	@echo $(TIME) $(GREEN)"Copy Settings index file"$(NC)
	@cp $^ $@

js-setup: $(SETUP_DIR)/mfw-setup-all.js
$(SETUP_DIR)/mfw-setup-all.js: $(APP_SETUP_ALL)
	@echo $(TIME) $(GREEN)"Building the Setup App"$(NC)
	@cat $^ > $@

html-setup: $(SETUP_DIR)/index.html
$(SETUP_DIR)/index.html: app/setup/index.html
	@echo $(TIME) $(GREEN)"Copy Setup index file"$(NC)
	@cp $^ $@

html-reports: $(REPORTS_DIR)/index.html
$(REPORTS_DIR)/index.html: app/reports/index.html
	@echo $(TIME) $(GREEN)"Copy Reports index file"$(NC)
	@cp $^ $@


dir: $(DESTDIR)
$(DESTDIR):
	@echo $(TIME) $(GREEN)"Creating DIRs"$(NC)
	@mkdir -p $(DESTDIR) $(ADMIN_DIR) $(STATIC_DIR) $(SETUP_DIR) $(SETTINGS_DIR) $(REPORTS_DIR)

LOCAL_DEPLOY_HOST := 192.168.101.212
copy:
	@echo "****************************************"
	@echo $(TIME) $(GREEN)"Deploying on local OpenWrt"$(NC)
	@scp -r $(DESTDIR)/* root@$(LOCAL_DEPLOY_HOST):/www
	@echo "****************************************"

deploy: install copy

watch:
	@echo $(TIME) $(YELLOW)"Waiting for changes..."$(NC)
	@while true; do \
		inotifywait -qr -e modify -e create -e delete -e move app package common sass; \
		make -f Makefile_local deploy; \
	done
