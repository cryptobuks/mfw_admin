#! /usr/bin/make -f

# Currently everything is deployed in /www/admin while it should be only under /www

DESTDIR ?= dist
# mfw Admin app
ADMIN_DIR ?= $(DESTDIR)/admin
# mfw resources dir which contains JS libs and images
STATIC_DIR ?= $(DESTDIR)/static
# mfw Setup app
SETUP_DIR ?= $(DESTDIR)/setup
# mfw stand-alone Settings app
SETTINGS_DIR ?= $(DESTDIR)/settings
# mfw stand-alone Reports app
REPORTS_DIR ?= $(DESTDIR)/reports



SASS := $(wildcard sass/*.scss)

# APPS SOURCES
APP_ADMIN_SRC := $(addprefix app/admin/src/, cmp dashboard) app/admin/src/App.js
APP_SETTINGS_SRC := $(addprefix app/settings/src/, cmp) app/settings/src

# PACKAGES SOURCES
PKG_SETTINGS_SRC := $(addprefix package/settings/src/, util model store component view) package/settings/src
PKG_REPORTS_SRC := $(addprefix package/reports/src/, model store) package/reports/src
PKG_AUTH_SRC := package/auth

# APPS ALL SOURCES
APP_ADMIN_ALL := app/AppBase.js \
	$(shell find $(APP_ADMIN_SRC) \
				 $(PKG_AUTH_SRC) \
				 $(PKG_SETTINGS_SRC) \
				 $(PKG_REPORTS_SRC) -name '*.js')

APP_SETTINGS_ALL := app/AppBase.js \
	$(shell find $(APP_SETTINGS_SRC) \
				 $(PKG_AUTH_SRC) \
				 $(PKG_SETTINGS_SRC) -name '*.js')

# RESOURCES
RESOURCES_VERSION := 0.1.0
RESOURCES_DIRECTORY := /tmp/mfw-resources
RESOURCES_FILE_NAME := mfw-admin-resources-$(RESOURCES_VERSION).tar.xz
RESOURCES_FILE := $(RESOURCES_DIRECTORY)/$(RESOURCES_FILE_NAME)
RESOURCES_URL := http://download.untangle.com/mfw/$(RESOURCES_FILE_NAME)
RESOURCES_BUCKET := s3://download.untangle.com/mfw/

install: \
	dir \
	css \
	js-admin \
	html-admin \
	js-settings \
	html-settings \
	html-reports \
	html-setup \
#	resources

resources: dir
	wget -O - $(RESOURCES_URL) | tar -C $(STATIC_DIR) -xJf -


TIME = $(shell date +%T.%3N)
YELLOW := "\033[1;33m"
GREEN := "\033[1;32m"
NC := "\033[0m" # No Color


#  This target requires sassc package!!!
css: $(ADMIN_DIR)/mfw-all.css $(SETTINGS_DIR)/mfw-all.css
$(ADMIN_DIR)/mfw-all.css $(SETTINGS_DIR)/mfw-all.css: $(SASS)
	@echo $(TIME) $(GREEN)"Building CSS"$(NC)
	@cat $^ | sassc --style expanded --stdin $@

js-admin: $(ADMIN_DIR)/mfw-admin-all.js
$(ADMIN_DIR)/mfw-admin-all.js: $(APP_ADMIN_ALL)
	@echo $(TIME) $(GREEN)"Building the Admin App"$(NC)
	@cat $^ > $@

html-admin: $(ADMIN_DIR)/index.html
$(ADMIN_DIR)/index.html: app/admin/index.html
	@echo $(TIME) $(GREEN)"Copy Admin index file"$(NC)
	@cp $^ $@

js-settings: $(SETTINGS_DIR)/mfw-settings-all.js
$(SETTINGS_DIR)/mfw-settings-all.js: $(APP_SETTINGS_ALL)
	@echo $(TIME) $(GREEN)"Building the Settings App"$(NC)
	@cat $^ > $@

html-settings: $(SETTINGS_DIR)/index.html
$(SETTINGS_DIR)/index.html: app/settings/index.html
	@echo $(TIME) $(GREEN)"Copy Settings index file"$(NC)
	@cp $^ $@


html-setup: $(SETUP_DIR)/index.html
$(SETUP_DIR)/index.html: app/setup/index.html
	@echo $(TIME) $(GREEN)"Copy Setup index file"$(NC)
	@cp $^ $@

html-reports: $(REPORTS_DIR)/index.html
$(REPORTS_DIR)/index.html: app/reports/index.html
	@echo $(TIME) $(GREEN)"Copy Reports index file"$(NC)
	@cp $^ $@



dir: $(DESTDIR)
$(DESTDIR):
	@echo $(TIME) $(GREEN)"Creating DIRs"$(NC)
	@mkdir -p $(DESTDIR) $(ADMIN_DIR) $(STATIC_DIR) $(SETUP_DIR) $(SETTINGS_DIR) $(REPORTS_DIR)

clean:
	rm -fr $(DESTDIR)

create-resources-tarball:
	@echo "Checking for $(RESOURCES_DIRECTORY)/res directory"
	@if [ ! -d $(RESOURCES_DIRECTORY)/res ] ; then echo "... failed" ; exit 1 ; fi
	@echo "Creating tarball from it"
	tar -C $(RESOURCES_DIRECTORY) -caf $(RESOURCES_FILE) res
	@echo "Your resources file is ready at $(RESOURCES_FILE)"

upload-resources-tarball:
	s3cmd put $(RESOURCES_FILE) $(RESOURCES_BUCKET)

.PHONY: \
	dir \
	css \
	js-admin \
	html-admin \
	js-settings \
	html-settings \
	html-reports \
	html-setup \
	resources

# used for local development

LOCAT_DEPLOY_HOST := 192.168.101.107
copy:
	@echo "****************************************"
	@echo $(TIME) $(GREEN)"Deploying build on local OpenWrt"$(NC)
	@scp -r $(DESTDIR)/* root@$(LOCAT_DEPLOY_HOST):/www/admin
	@echo "****************************************"

deploy: install copy

watch:
	@echo $(TIME) $(YELLOW)"Waiting for changes..."$(NC)
	@while true; do \
		inotifywait -qr -e modify -e create -e delete -e move app package sass; \
		make deploy; \
	done


